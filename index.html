<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©íƒˆì¶œ: 1950ë…„ìœ¼ë¡œì˜ ì‹œê°„ì—¬í–‰</title>
    <style>
        body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;font-family:'Malgun Gothic',sans-serif;background-color:#333;display:flex;justify-content:center;align-items:center}
        #start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:2000;display:flex;justify-content:center;align-items:center;flex-direction:column;color:#fff}
        #start-form{background-color:#f0f0f0;color:#333;padding:40px;border-radius:20px;text-align:center;box-shadow:0 10px 20px rgba(0,0,0,.2)}
        #start-form h1{margin-top:0;margin-bottom:30px;color:#2c3e50}
        .player-info-input{display:block;width:250px;padding:12px;margin:10px auto;border-radius:5px;border:1px solid #ccc;font-size:1em}
        #start-button{background-color:#27ae60;color:#fff;padding:15px 30px;border:none;border-radius:8px;cursor:pointer;font-size:1.2em;font-weight:700;margin-top:20px;transition:background-color .3s}
        #start-button:hover{background-color:#2ecc71}
        #game-container{display:none;position:relative;max-width:1024px;width:100%;aspect-ratio:1024/683;background-image:url(classroom.jpg);background-size:contain;background-repeat:no-repeat;background-position:center}
        #timer-display{position:absolute;top:20px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,.75);color:#fff;padding:10px 20px;border-radius:10px;font-size:1.8em;font-weight:700;border:2px solid #fff;z-index:50;font-family:'Courier New',Courier,monospace}
        .clickable-area{position:absolute;cursor:pointer;transition:all .2s ease}
        .clickable-area:hover{background-color:rgba(255,255,0,.3);box-shadow:0 0 15px 5px rgba(255,255,0,.5);border-radius:10px}
        .clickable-area.solved{pointer-events:none;background-color:rgba(0,255,0,.4);opacity:.7}
        #monitor-area{top:48%;left:73%;width:9%;height:11%}#speaker-area{top:23%;left:70%;width:6%;height:11%}#clock-area{top:25%;left:46%;width:5%;height:8%}#door-area{top:35%;left:8%;width:11%;height:33%}
        #clue-board{position:absolute;bottom:20px;right:20px;background-color:rgba(0,0,0,.7);color:#fff;padding:15px;border-radius:10px;border:2px solid #fff;font-size:1.2em;z-index:100}
        #clues{margin-top:10px;font-size:1.5em;letter-spacing:10px;color:#ffcc00;min-height:30px}
        .modal-container{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);justify-content:center;align-items:center}
        .modal-content{background-color:#fefefe;padding:30px;border-radius:15px;width:90%;max-width:600px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.3);animation:fadeIn .3s}
        .modal-content h2{margin-top:0}.modal-content p{font-size:1.1em;line-height:1.6}.modal-content button{background-color:#4caf50;color:#fff;padding:12px 20px;border:none;border-radius:5px;cursor:pointer;font-size:1em;margin-top:20px}.modal-content button:hover{background-color:#45a049}.close-button{background-color:#f44336!important}.close-button:hover{background-color:#da190b!important}.modal-input{width:80%;padding:10px;margin:20px 0;font-size:1.2em;text-align:center;border:1px solid #ccc;border-radius:5px}
        @keyframes fadeIn{0%{opacity:0;transform:scale(.9)}100%{opacity:1;transform:scale(1)}}
        #memory-game-board{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:100%;max-width:400px;margin:20px auto;perspective:1000px}
        .memory-card{width:100%;aspect-ratio:1/1;position:relative;transform-style:preserve-3d;transition:transform .6s;cursor:pointer}.memory-card.flip{transform:rotateY(180deg)}
        .back-face,.front-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:10px;display:flex;justify-content:center;align-items:center;font-size:2em}
        .front-face{transform:rotateY(180deg);background-color:#fff;border:2px solid #ddd}.back-face{background-color:#5c8d89;color:#fff;border:2px solid #74b49b;font-size:2.5em}
        #success-screen{flex-direction:column;text-align:center}
        #success-screen h1{font-size:3em;color:#ffeb3b;margin-bottom:20px}
        #result-details{background-color:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:20px;margin-bottom:20px;color:#fff;width:90%;max-width:500px}
        #result-details p{font-size:1.3em;margin:10px 0}#result-details span{font-weight:700;color:#82e0aa}
        #feedback-textarea{width:80%;max-width:480px;height:100px;margin-top:10px;padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;resize:vertical}
        #save-and-retry-button{background-color:#3498db;color:#fff;padding:15px 30px;border:none;border-radius:8px;cursor:pointer;font-size:1.2em;font-weight:700;margin-top:20px;transition:background-color .3s}
        #save-and-retry-button:hover{background-color:#2980b9}
        #save-and-retry-button:disabled{background-color:#bdc3c7;cursor:not-allowed}
        #save-status{color:#fff;margin-top:15px;font-size:1.1em;height:20px}
    </style>
</head>
<body>
    <div id="start-screen">
        <div id="start-form">
            <h1>ë°©íƒˆì¶œ: 1950ë…„ìœ¼ë¡œì˜ ì‹œê°„ì—¬í–‰</h1>
            <input type="text" id="player-grade" class="player-info-input" placeholder="í•™ë…„ (ì˜ˆ: 6)">
            <input type="text" id="player-class" class="player-info-input" placeholder="ë°˜ (ì˜ˆ: 1)">
            <input type="text" id="player-name" class="player-info-input" placeholder="ì´ë¦„ (ì˜ˆ: ì¥ì›ì˜)">
            <button id="start-button">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>
    <div id="game-container">
        <div id="timer-display">00:00</div>
        <div class="clickable-area" id="monitor-area" data-id="monitor"></div>
        <div class="clickable-area" id="speaker-area" data-id="speaker"></div>
        <div class="clickable-area" id="clock-area" data-id="clock"></div>
        <div class="clickable-area" id="door-area" data-id="door"></div>
        <div id="clue-board"><strong>íšë“í•œ ë‹¨ì„œ:</strong><div id="clues"></div></div>
    </div>
    <div id="modal-container" class="modal-container">
        <div id="modal-content" class="modal-content"></div>
    </div>
    <div id="success-screen" class="modal-container">
        <h1 id="success-title">ğŸ‰ íƒˆì¶œ ì„±ê³µ! ğŸ‰</h1>
        <div id="result-details">
            <p>ì°¸ê°€ì: <span id="final-player-info"></span></p>
            <p>ì†Œìš” ì‹œê°„: <span id="final-time"></span></p>
        </div>
        <textarea id="feedback-textarea" placeholder="ê²Œì„ ì†Œê°ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”!"></textarea>
        <p id="save-status"></p>
        <button id="save-and-retry-button">ì†Œê° ì €ì¥í•˜ê³  ë‹¤ì‹œí•˜ê¸°</button>
    </div>

<script>
    // --- [ì¤‘ìš”!] ì—¬ê¸°ì— êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQWLOJ0d6J5yhJFDhe3-Py9Q1P7Wj--p2QnJBY4OX2lESklimxESWBBvRAni_IJiAmdg/exec'; // ì˜ˆì‹œ: 'https://script.google.com/macros/s/AKfy.../exec'

    // --- ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ì„ ì–¸ ---
    const gameState = { player: {}, clues: {}, solved: [], isGameRunning: true };
    let startTime, timerInterval, finalTimeValue;

    const startScreen = document.getElementById('start-screen');
    const startButton = document.getElementById('start-button');
    const playerGradeInput = document.getElementById('player-grade');
    const playerClassInput = document.getElementById('player-class');
    const playerNameInput = document.getElementById('player-name');
    const gameContainer = document.getElementById('game-container');
    const timerDisplay = document.getElementById('timer-display');
    const clueDisplay = document.getElementById('clues');
    const modalContainer = document.getElementById('modal-container');
    const modalContent = document.getElementById('modal-content');
    const successScreen = document.getElementById('success-screen');
    const saveAndRetryButton = document.getElementById('save-and-retry-button');

    // --- ì˜¤ë¸Œì íŠ¸ ë°ì´í„° ---
    const objectData = {
        monitor: { type: 'problem', title: 'ëª¨ë‹ˆí„°ì˜ ì§ˆë¬¸', content: `í•œêµ­ì „ìŸì€ ë¶í•œì˜ ë‚¨ì¹¨ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆì–´ìš”.<br><strong>í•œêµ­ì „ìŸì´ ì¼ì–´ë‚œ í•´</strong>ëŠ” ì–¸ì œì¼ê¹Œìš”?`, answer: '1950', clue: '1' },
        speaker: { type: 'hint', title: 'ë²½ ìŠ¤í”¼ì»¤ì—ì„œ ë“¤ë¦¬ëŠ” ì†Œë¦¬', content: `ì‚... ì‚...<br>"ê¸°ì–µí•˜ë¼. ì „ìŸì´ ë©ˆì¶˜ ë‚ ... <strong>1953ë…„ 7ì›” 27ì¼</strong>..."<br>ìŠ¤í”¼ì»¤ì—ì„œ ì •ì „í˜‘ì •ì— ëŒ€í•œ ëª©ì†Œë¦¬ê°€ ë“¤ë ¤ì˜¨ë‹¤.`, clue: '9' },
        clock: { type: 'minigame', title: 'ê³ ì¥ ë‚œ ì‹œê³„', content: 'ì‹œê³„ê°€ ê³ ì¥ë‚˜ ì‹œê°„ì´ ë’¤ì£½ë°•ì£½ì´ ë˜ì—ˆì–´ìš”!<br>ì‹œê°„ì„ ë˜ëŒë¦¬ë ¤ë©´ ì§ì„ ë§ëŠ” ì¹´ë“œë¥¼ ëª¨ë‘ ì°¾ì•„ì•¼ í•´ìš”.', clue: '5' },
        door: { type: 'escape', title: 'êµì‹¤ ë¬¸', content: 'íƒˆì¶œí•˜ë ¤ë©´ ë„¤ ìë¦¬ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•˜ë‹¤.<br>ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ë‹¨ì„œë“¤ì„ ìˆœì„œëŒ€ë¡œ ì¡°í•©í•´ë³´ì!', answer: '1950' }
    };

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
    startButton.addEventListener('click', startGame);
    gameContainer.addEventListener('click', handleGameClick);
    saveAndRetryButton.addEventListener('click', handleSaveAndRetry);

    // --- í•¨ìˆ˜ ì •ì˜ ---
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const sec = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function startGame() {
        const grade = playerGradeInput.value.trim();
        const className = playerClassInput.value.trim();
        const name = playerNameInput.value.trim();
        if (!grade || !className || !name) {
            alert('í•™ë…„, ë°˜, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }
        gameState.player = { grade, class: className, name };
        startScreen.style.display = 'none';
        gameContainer.style.display = 'block';
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsed);
        }, 1000);
    }

    function handleGameClick(e) {
        if (!gameState.isGameRunning || !e.target.classList.contains('clickable-area')) return;
        const id = e.target.dataset.id;
        if (gameState.solved.includes(id)) return;
        triggerObject(id);
    }

    function triggerObject(id) {
        const data = objectData[id];
        switch (data.type) {
            case 'problem': showProblemModal(id, data); break;
            case 'hint': showHintModal(id, data); break;
            case 'minigame': showMinigameModal(id, data); break;
            case 'escape': showEscapeModal(id, data); break;
        }
    }

    function openModal(html) {
        modalContent.innerHTML = html;
        modalContainer.style.display = 'flex';
    }

    function closeModal() {
        modalContainer.style.display = 'none';
        modalContent.innerHTML = '';
    }

    function showProblemModal(id, data) {
        const html = `<h2>${data.title}</h2><p>${data.content}</p><input type="text" id="problem-input" class="modal-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"><button id="submit-answer">ì •ë‹µ í™•ì¸</button><button class="close-button" onclick="closeModal()">ë‹«ê¸°</button>`;
        openModal(html);
        modalContent.querySelector('#submit-answer').onclick = () => {
            if (modalContent.querySelector('#problem-input').value.trim() === data.answer) {
                alert('ì •ë‹µì…ë‹ˆë‹¤! ë‹¨ì„œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.');
                addClue(id, data.clue);
                closeModal();
            } else {
                alert('í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.');
            }
        };
    }

    function showHintModal(id, data) {
        const html = `<h2>${data.title}</h2><p>${data.content}</p><button id="get-clue">ë‹¨ì„œ í™•ì¸</button>`;
        openModal(html);
        modalContent.querySelector('#get-clue').onclick = () => {
            alert('ë‹¨ì„œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!');
            addClue(id, data.clue);
            closeModal();
        };
    }

    function showMinigameModal(id, data) {
        const html = `<h2>ì‹œê³„ ì† ì§ˆë¬¸</h2><p>ìŠ¤í”¼ì»¤ì—ì„œ ë“¤ë ¸ë˜ íŒíŠ¸ë¥¼ ê¸°ì–µí•˜ì„¸ìš”!<br><strong>í•œêµ­ì „ìŸ ì •ì „í˜‘ì •ì¼</strong>ì€ ì–¸ì œì¼ê¹Œìš”?</p><button class="choice-btn" data-answer="correct">B. 1953ë…„ 7ì›” 27ì¼</button><button class="choice-btn" data-answer="wrong">A. 1950ë…„ 6ì›” 25ì¼</button><button class="choice-btn" data-answer="wrong">C. 1945ë…„ 8ì›” 15ì¼</button><hr style="margin: 20px 0;"><h2>${data.title}</h2><p>${data.content}</p><div id="memory-game-board"></div><button class="close-button" onclick="closeModal()">ë‚˜ì¤‘ì— í’€ê¸°</button>`;
        openModal(html);
        let questionSolved = false;
        modalContent.querySelectorAll('.choice-btn').forEach(btn => {
            btn.onclick = (e) => {
                if (questionSolved) return;
                if (e.target.dataset.answer === 'correct') {
                    alert('ì •ë‹µì…ë‹ˆë‹¤! ì´ì œ ë©”ëª¨ë¦¬ ê²Œì„ì„ í’€ì–´ ë‹¨ì„œë¥¼ ì–»ìœ¼ì„¸ìš”.');
                    questionSolved = true;
                } else {
                    alert('í‹€ë ¸ì–´ìš”! ìŠ¤í”¼ì»¤ì—ì„œ ë“¤ì—ˆë˜ ë‚´ìš©ì„ ë‹¤ì‹œ ë– ì˜¬ë ¤ë³´ì„¸ìš”.');
                }
            };
        });
        setupMemoryGame(id, data.clue);
    }

    function showEscapeModal(id, data) {
        const html = `<h2>${data.title}</h2><p>${data.content}</p><input type="text" id="password-input" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" maxlength="4"><button id="submit-password">íƒˆì¶œ ì‹œë„</button><button class="close-button" onclick="closeModal()">ë‹«ê¸°</button>`;
        openModal(html);
        document.getElementById('submit-password').onclick = () => {
            if (document.getElementById('password-input').value === data.answer) {
                gameState.isGameRunning = false;
                clearInterval(timerInterval);
                const finalTimeInSeconds = Math.floor((Date.now() - startTime) / 1000);
                finalTimeValue = formatTime(finalTimeInSeconds);
                closeModal();
                document.getElementById('success-title').textContent = `ğŸ‰ ${gameState.player.name} í•™ìƒ, íƒˆì¶œ ì„±ê³µ! ğŸ‰`;
                document.getElementById('final-player-info').textContent = `${gameState.player.grade}í•™ë…„ ${gameState.player.class}ë°˜`;
                document.getElementById('final-time').textContent = finalTimeValue;
                successScreen.style.display = 'flex';
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!');
            }
        };
    }

    function addClue(id, clue) {
        if (gameState.solved.includes(id)) return;
        gameState.clues[id] = clue;
        gameState.solved.push(id);
        document.getElementById(`${id}-area`).classList.add('solved');
        let clueText = '';
        if (gameState.clues.monitor) clueText += gameState.clues.monitor;
        if (gameState.clues.speaker) clueText += gameState.clues.speaker;
        if (gameState.clues.clock) clueText += gameState.clues.clock;
        if (gameState.solved.length >= 3 && !gameState.clues.final) {
            gameState.clues.final = '0';
            alert("ëª¨ë“  í¼ì¦ì„ í’€ì—ˆë”ë‹ˆ ë§ˆì§€ë§‰ ë‹¨ì„œ '0'ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!");
        }
        clueText += gameState.clues.final || '';
        clueDisplay.textContent = clueText.split('').join(' ');
    }

    function setupMemoryGame(id, clue) {
        const board = document.getElementById('memory-game-board');
        if (!board) return;
        const items = ['ğŸ•Šï¸', 'ğŸ—ºï¸', 'ğŸ¤', 'ğŸ–ï¸', 'ğŸ•Šï¸', 'ğŸ—ºï¸', 'ğŸ¤', 'ğŸ–ï¸'];
        items.sort(() => 0.5 - Math.random());
        items.forEach(item => {
            const card = document.createElement('div');
            card.classList.add('memory-card');
            card.dataset.item = item;
            card.innerHTML = `<div class="front-face">${item}</div><div class="back-face">?</div>`;
            board.appendChild(card);
        });
        let hasFlippedCard = false, lockBoard = false, firstCard, secondCard;
        let matchedPairs = 0;
        board.querySelectorAll('.memory-card').forEach(card => card.addEventListener('click', flipCard));
        function flipCard() {
            if (lockBoard || this === firstCard) return;
            this.classList.add('flip');
            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }
            secondCard = this;
            checkForMatch();
        }
        function checkForMatch() { firstCard.dataset.item === secondCard.dataset.item ? disableCards() : unflipCards(); }
        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            resetBoard();
            matchedPairs++;
            if (matchedPairs === items.length / 2) {
                setTimeout(() => {
                    alert('ë©”ëª¨ë¦¬ ê²Œì„ ì„±ê³µ! ë‹¨ì„œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.');
                    addClue(id, clue);
                    closeModal();
                }, 500);
            }
        }
        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('flip');
                secondCard.classList.remove('flip');
                resetBoard();
            }, 1000);
        }
        function resetBoard() { [hasFlippedCard, lockBoard] = [false, false]; [firstCard, secondCard] = [null, null]; }
    }

    function handleSaveAndRetry() {
        saveDataToSheet();
        saveAndRetryButton.disabled = true;
        saveAndRetryButton.textContent = 'ì €ì¥ ì™„ë£Œ!';
        setTimeout(() => { location.reload(); }, 2000);
    }

    function saveDataToSheet() {
        const feedback = document.getElementById('feedback-textarea').value;
        const saveStatus = document.getElementById('save-status');
        if (!SCRIPT_URL) {
            saveStatus.textContent = 'ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨: ìŠ¤í¬ë¦½íŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            return;
        }
        saveStatus.textContent = 'ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...';
        const dataToSave = {
            grade: gameState.player.grade,
            class: gameState.player.class,
            name: gameState.player.name,
            time: finalTimeValue,
            feedback: feedback || "ì†Œê° ì—†ìŒ"
        };
        fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(dataToSave) })
            .then(r => r.json())
            .then(d => {
                if (d.result === 'success') {
                    saveStatus.textContent = 'âœ… ê²°ê³¼ê°€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    saveStatus.style.color = '#2ecc71';
                } else { throw new Error(d.message); }
            })
            .catch(e => {
                console.error('Error:', e);
                saveStatus.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨: ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                saveStatus.style.color = '#e74c3c';
            });
    }
</script>
</body>
</html>